<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html" charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
    <style type="text/css">

      body {
        font-family: 'Oswald', serif;
        background-color:#615a55;
        font-size: 12px;
        font-weight: 300;
        color: #f7f7ff;
      }

      p {
         padding:0px; 
         margin:0px;
      }


      a:link {color:#dfb431;}
      a:visited {color:#dfb431;}

      div.tooltip {
		position: absolute;
        font-size: 14px;
        text-align: left;
        padding: 6px;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
      
      .district { 
        fill: #333333;
        stroke: #262626;
        stroke-width: 2px;
      }
      
      .mesh {
        stroke-width: .5px;
        stroke-linejoin: round;
      }
      
      .boundary {
        stroke: #FFFFFF;
        stroke-width: 2px;
        fill: none;
      }

      .dot {
          fill: #dfb431;
      }

</style>
</head>
<body background-color: #999988;>

<p style = 'font-size:26px'><strong>Stolpersteine for Holocaust victims in Berlin</strong></p>

<div id="map"></div>
<p>
<div id="tooltip"></div>

<script type="text/javascript">

 var width = 1000, height = 800;


 var projection = d3.geo.albers()
     .rotate([-7, 0]);

 var path = d3.geo.path()
     .projection(projection);

 var svg = d3.select("#map").append("svg")
     .attr("width", width)
     .attr("height", height);

 d3.json('berlin.json', function(error, data) {

     var districts = topojson.feature(data, data.objects.states);

     projection
         .scale(1)
         .translate([0, 0]);
     
     // District boundaries
     var b = path.bounds(districts),
         s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
         t = [((width - s * (b[1][0] + b[0][0])) / 2) + 20, (height - s * (b[1][1] + b[0][1])) / 2];

     projection
         .scale(s)
         .translate(t);

     svg.append("path")
         .datum(topojson.mesh(data, data.objects.states, function(a, b) { return a !== b; }))
         .attr("class", "mesh")
         .attr("d", path);

     svg.selectAll("district")
         .data(topojson.feature(data, data.objects.states).features)
         .enter().append("path")
         .attr("class", "district")
         .attr("d", path);

     var div = d3.select("#tooltip")
         .append("div")   
         .attr("class", "tooltip")
         .style("opacity", 0);

     d3.tsv("stolpersteine.tsv", function(error, data) {

         pd = d3.time.format("%Y-%m-%d").parse
         fd = d3.time.format("%d.%m.%Y")
         yr = d3.time.format("%Y")
         dp = d3.time.days

         data.forEach(function(d) {
             d.lat = +d.lat;
             d.lng = +d.lng;
             d.posdeport = pd(d.deport)
             d.posdeath = pd(d.death)
             
             if (d.murder == '') {
                 d.murder = 'unbekannter Todesort'
             } 
         });

         var dots = svg.selectAll("circle")
             .data(data, function(d) { return d.name;})

         dots.enter()
             .append("circle")
             .attr("r", 0)
             .attr("name", function(d) { return d.name;})
             .attr("transform", function(d) {
                 return "translate(" + projection([d.lng, d.lat]) + ")";
             })
             .attr("class", "dot")
             .on("mouseover", function(d) {
                 div.transition()        
                     .duration(50)
                     .style("opacity", 1);

                 if(d.deport != "1945-05-08" && d.death != "1945-05-08") {
                     div.html("<p style='font-size:22px; color: #dfb431'><strong>" + d.name + "</strong></p>" + 
                              "<p>" + d.address + "</p>" +
                              "<p style='padding-top: 8px'>Deportiert am " + fd(d.posdeport) + "<br/>" +
                              "Ermordet am "  + fd(d.posdeath) + " (" + d.murder + ")")
                              .style("left", "20px")
                              .style("top", "60px");
                 } else if (d.death == "1945-05-08" && d.murder != "Unbekannter Todesort"){
                     div.html("<p style='font-size:22px; color: #dfb431'><strong>" + d.name + "</strong></p>" + 
                              "<p>" + d.address + "</p>" +
                              "<p style='padding-top: 8px'>Ermordet in "  + d.murder + "</p>")
                              .style("left", "20px")
                              .style("top", "60px");
                 } else {
                     div.html("<p style='font-size:22px; color: #dfb431'><strong>" + d.name + "</strong></p>" + 
                              "<p>" + d.address + "</p>")
                              .style("left", "20px")
                              .style("top", "60px");
                 }
                        
                 d3.select(this)
                     .transition()
                     .duration(100)
                     .attr("r", 8);
                 
             })
             .on("mouseout", function(d) {
                 div.transition()        
                     .duration(500)      
                     .style("opacity", 0);
                 
                 d3.select(this)
                     .transition()
                     .duration(250)
                     .attr("r", 3);
             });
         

     });

     d3.selectAll("#map")
         .on("click", function() {
             svg.selectAll("circle")
                 .transition()
                 .duration(1500)
                 .delay(function(d) {
                     return d.timestamp * 2;
                 })
                 .attr("r", 3)
                 .attr("opacity", .5);
     });
    
});

</script>
<p style='font-size: 18px'>The data for this visualization come from
  Berlin's <a href="http://daten.berlin.de/datensaetze/liste-der-stolpersteine-berlin"
  target="new">open data initiative</a> (licensed
  under <a href="http://creativecommons.org/licenses/by/3.0/"
  target="new">Creative Commons Attribution</a>). Each dot represents
  a <a href="http://www.stolpersteine-berlin.de"
  target="new"><i>Stolperstein</i></a> (stumbling block). Those are brass plates
  that remind us of the victims of the Third Reich holocaust at the places where
  they used to live. The code for data preparation and visualization can be
  found at
  <a href="http://www.github.com/plmtznr/stolpersteine"
  target="new">http://www.github.com/plmtznr/stolpersteine</a>.</p>
</body>
</html>
