<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html" charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
    <style type="text/css">

     body {
       font-family: 'Oswald', serif;
       background-color:#615a55;
       font-size: 12px;
       font-weight: 300;
       color: #f7f7ff;
     }

     h1 {
       font-size: 36px;
       font-weight: 700;
       padding: 10px;
       color: #dfb431;
     }
     
     div.starter {
       font-size: 32px;
       font-weight: 700;
       position: absolute;
       color: #dfb431;
       margin: auto;
       display: block;
     }

     p {
       padding:0px; 
       margin:0px;
     }

     a:link {color:#dfb431;}
     a:visited {color:#dfb431;}

     div.tooltip {
	   position: absolute;
       font-size: 14px;
       text-align: left;
       padding: 6px;
       border: 0px;
       border-radius: 8px;
       pointer-events: none;
     }
     
     .district { 
       fill: #333333;
       stroke: #262626;
       stroke-width: 2px;
     }
     
     .mesh {
       stroke-width: .5px;
       stroke-linejoin: round;
     }

     .dot {
       fill: #dfb431;
     }

</style>
</head>

<body>

<h1>STOLPERSTEINE FOR HOLOCAUST VICTIMS IN BERLIN</h1>

<div id="tooltip"></div>
<p>
<div id="map"></div>
<!-- <input type="range" value="0" min="0" max="255" step="any"> -->

<script type="text/javascript">
    
  var width = 800, height = 600;

  var projection = d3.geo.albers()
      .rotate([-7, 0]);

  var path = d3.geo.path()
      .projection(projection);
  
  var svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", height);
  
  d3.json('berlin.json', function(error, data) {
      
      var districts = topojson.feature(data, data.objects.states);
      
      var tooltip = d3.select("#tooltip")
          .append("div")   
          .attr("class", "tooltip")
          .style("opacity", 0);
      
      var starter = d3.selectAll("#map")
          .append("div");

      projection
          .scale(1)
          .translate([0, 0]);
      
      var b = path.bounds(districts),
          s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
          t = [((width - s * (b[1][0] + b[0][0])) / 2) + 20, (height - s * (b[1][1] + b[0][1])) / 2];
      
      projection
          .scale(s)
          .translate(t);
      
      svg.append("path")
          .datum(topojson.mesh(data, data.objects.states, function(a, b) { return a !== b; }))
          .attr("class", "mesh")
          .attr("d", path);
      
      svg.selectAll("district")
          .data(topojson.feature(data, data.objects.states).features)
          .enter().append("path")
          .attr("class", "district")
          .attr("d", path);
      
      starter.html("Click on map to show <i>Stolpersteine</i> in chronological order")
          .attr("class", "starter")
          .style("width", width)
          .style("left", width/6 + "px")
          .style("top", (height / 3) * 1.75 + "px");
      
      d3.tsv("stolpersteine.tsv", function(error, data) {
          
          pd = d3.time.format("%Y-%m-%d").parse
          fd = d3.time.format("%B %-d, %Y")
          
          data.forEach(function(d) {
              d.lat = +d.lat;
              d.lng = +d.lng;
              d.posdeport = pd(d.deport)
              d.posdeath = pd(d.death)
          });
          
          var dots = svg.selectAll("circle")
              .data(data, function(d) { return d.name;})
          
          dots.enter()
              .append("circle")
              .attr("r", 0)
              .attr("opacity", 0.35)
              .attr("name", function(d) { return d.name;})
              .attr("transform", function(d) {
                  return "translate(" + projection([d.lng, d.lat]) + ")";
              })
              .attr("class", "dot")
              .on("mouseover", function(d) {
                  tooltip.transition()        
                      .duration(50)
                      .style("opacity", 1);
                  
                  if(d.deport != "1945-05-08" && d.death != "1945-05-08") {
                      tooltip.html("<p style='font-size:22px; color: #dfb431'><strong>" + d.name + "</strong></p>" + 
                                   "<p>" + d.address + "</p>" +
                                   "<p style='padding-top: 8px'>Deported " + fd(d.posdeport) + "<br/>" +
                                   "Murdered "  + fd(d.posdeath) + " (" + d.murder + ")")
                          .style("left", width * 2/3 + "px")
                          .style("top", height/4 + "px");
                  } else if (d.death == "1945-05-08" && d.murder != "place of death unknown"){
                      tooltip.html("<p style='font-size:22px; color: #dfb431'><strong>" + d.name + "</strong></p>" + 
                                   "<p>" + d.address + "</p>" +
                                   "<p style='padding-top: 8px'>Murdered in "  + d.murder + "</p>")
                          .style("left", width * 2/3 + "px")
                          .style("top", height/4 + "px");
                  } else {
                      tooltip.html("<p style='font-size:22px; color: #dfb431'><strong>" + d.name + "</strong></p>" + 
                                   "<p>" + d.address + "</p>")
                          .style("left", width * 2/3 + "px")
                          .style("top", height/4 + "px");
                  }
                  
                  d3.select(this)
                      .transition()
                      .duration(100)
                      .attr("r", 8);
                  
              })
              .on("mouseout", function(d) {
                  tooltip.transition()        
                      .duration(500)      
                      .style("opacity", 0);
                  
                  d3.select(this)
                      .transition()
                      .duration(250)
                      .attr("r", 2);
              });
          
          
      });

      d3.selectAll("#map")
          .on("click", function() {
              
              starter.transition()
                  .duration(250)
                  .attr("opacity", 0)
                  .remove();
              
              svg.selectAll("circle")
                  .transition()
                  .duration(1500)
                  .delay(function(d) {
                      return d.timestamp * 2 + (Math.random() * 10);
                  })
                  .attr("r", 3);
          });
      
  });
  
</script>
<p style="font-size: 18px; width:800px; padding: 10px">The data for this visualization come from
  Berlin's <a href="http://daten.berlin.de/datensaetze/liste-der-stolpersteine-berlin"
              target="new">open data initiative</a> (licensed
  under <a href="http://creativecommons.org/licenses/by/3.0/"
           target="new">Creative Commons Attribution</a>). Each dot represents
  a <a href="http://www.stolpersteine-berlin.de"
       target="new"><i>Stolperstein</i></a> (stumbling block). Those are brass plates
  that remind us of the victims of the Third Reich holocaust at the places where
  they used to live. The code for data preparation and visualization can be
  found at
  <a href="http://www.github.com/plmtznr/stolpersteine"
     target="new">http://www.github.com/plmtznr/stolpersteine</a>.</p>
</body>
</html>
